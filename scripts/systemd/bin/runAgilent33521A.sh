#!/usr/bin/env bash

set -u

if [ -z "$AGILENT33521A_INSTANCE" ]; then
    echo "AGILENT33521A_INSTANCE environment variable is not set." >&2
    exit 1
fi

export AGILENT33521A_CURRENT_PV_AREA_PREFIX=AGILENT33521A_${AGILENT33521A_INSTANCE}_PV_AREA_PREFIX
export AGILENT33521A_CURRENT_PV_DEVICE_PREFIX=AGILENT33521A_${AGILENT33521A_INSTANCE}_PV_DEVICE_PREFIX
export AGILENT33521A_CURRENT_DEVICE_IP=AGILENT33521A_${AGILENT33521A_INSTANCE}_DEVICE_IP
export AGILENT33521A_CURRENT_DEVICE_PORT=AGILENT33521A_${AGILENT33521A_INSTANCE}_DEVICE_PORT
export AGILENT33521A_CURRENT_DEVICE_TELNET_PORT_SUFFIX=AGILENT33521A_${AGILENT33521A_INSTANCE}_TELNET_PORT_SUFFIX
# Only works with bash
export AGILENT33521A_PV_AREA_PREFIX=${!AGILENT33521A_CURRENT_PV_AREA_PREFIX}
export AGILENT33521A_PV_DEVICE_PREFIX=${!AGILENT33521A_CURRENT_PV_DEVICE_PREFIX}
export AGILENT33521A_DEVICE_IP=${!AGILENT33521A_CURRENT_DEVICE_IP}
export AGILENT33521A_DEVICE_PORT=${!AGILENT33521A_CURRENT_DEVICE_PORT}
export AGILENT33521A_DEVICE_TELNET_PORT=${PROCSERV_AGILENT33521A_PORT_PREFIX}${!AGILENT33521A_CURRENT_DEVICE_TELNET_PORT_SUFFIX}

if [ -z "${AGILENT33521A_CURRENT_DEVICE_TELNET_PORT_SUFFIX}" ]; then
    echo "TELNET port is not set." >&2
    exit 1
fi

./runProcServ.sh \
    -i "${AGILENT33521A_DEVICE_IP}" \
    -p "${AGILENT33521A_DEVICE_PORT}" \
    -P "${AGILENT33521A_PV_AREA_PREFIX}" \
    -R "${AGILENT33521A_PV_DEVICE_PREFIX}"
